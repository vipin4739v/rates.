<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
body { font-family: 'Poppins', sans-serif; margin:0; background:#fffdfb; color:#222; }
.sidebar { width:220px; height:100vh; position:fixed; background:#fafafa; padding-top:30px; box-shadow:5px 0 20px rgba(0,0,0,0.1); text-align:center; z-index:999; }
.sidebar img { width:140px; height:auto; margin-bottom:25px; }
.sidebar a { display:flex; align-items:center; gap:12px; padding:14px 20px; color:#ff7f50; text-decoration:none; margin:6px 0; font-weight:500; border-radius:0 25px 25px 0; transition:all 0.3s; }
.sidebar a:hover { background:#ff7f5020; transform:translateX(6px); }
.main { margin-left:220px; padding:30px; transition:margin-left 0.3s; }
.card-container { display:flex; gap:20px; flex-wrap:wrap; margin-bottom:20px; }
.card { background:#fff; padding:25px; border-radius:16px; box-shadow:0 8px 20px rgba(255,127,80,0.15); position:relative; flex:1; min-width:280px; }
.card h2 { color:#ff7f50; margin-bottom:14px; font-size:20px; }
.btn, input[type="submit"], button { display:inline-block; margin-top:10px; padding:10px 22px; background:#ff7f50; color:white; border:none; border-radius:50px; font-weight:500; cursor:pointer; transition:0.3s; text-decoration:none; }
.btn:hover, input[type="submit"]:hover, button:hover { background:#e06b3f; }
input[type="file"], input[type="text"], select { margin:10px 0; width:100%; padding:12px; border-radius:10px; border:1px solid #ff7f50; font-size:14px; }
.table-responsive { width:100%; overflow-x:auto; margin-top:15px; }
.table-responsive table { width:100%; border-collapse:collapse; min-width:600px; border-radius:10px; overflow:hidden; box-shadow:0 4px 12px rgba(255,127,80,0.08); }
th, td { padding:10px; text-align:left; font-size:14px; border-bottom:1px solid #eee; }
th { background:#ff7f50; color:white; }
tr:nth-child(even) { background:#fff7f2; }
.pagination { margin-top:18px; }
.pagination a { margin-right:8px; padding:7px 14px; background:#ff7f50; color:white; border-radius:30px; text-decoration:none; }
.pagination a:hover { background:#e06b3f; }
.logout-btn { padding:8px 18px; background:#ff7f50; color:white; border-radius:50px; text-decoration:none; font-weight:500; }
.logout-btn:hover { background:#e06b3f; }
.alert { padding:10px; border-radius:8px; margin-bottom:15px; background:#e0f3ff; color:#005b8a; }
</style>
</head>
<body>

<div class="sidebar">
    <img src="https://www.hinditsolution.com/assets/images/logo.png" alt="Logo">
    <a href="{{ url_for('dashboard') }}"><i class="fas fa-home"></i> Dashboard</a>
    <a href="#"><i class="fas fa-users"></i> Users</a>
    <a href="#"><i class="fas fa-cogs"></i> Settings</a>
</div>

<div class="main">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom:20px;">
        <h1 style="font-size:22px; color:#000;">Welcome, {{ username }} ({{ role }})</h1>
        <a href="{{ url_for('logout') }}" class="logout-btn"><i class="fas fa-user-circle"></i> Logout</a>
    </div>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="alert">
        {% for msg in messages %}<div>{{ msg }}</div>{% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="card-container">
        {% if role=="admin" %}
        <div class="card">
            <h2>Upload Excel Sheet</h2>
            <form method="POST" enctype="multipart/form-data">
                <input type="file" name="file" accept=".xlsx" required>
                <input type="submit" value="Upload">
            </form>
        </div>
        {% endif %}

        

        <div class="card" style="flex:2;">
            <h2>Search Data</h2>
            <form method="GET" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                <select name="selected_file" onchange="this.form.submit()">
                    {% for f in files_list %}
                    <option value="{{ f }}" {% if f==selected_file %}selected{% endif %}>{{ f }}</option>
                    {% endfor %}
                </select>
                <input type="text" name="search" placeholder="Search (comma separated)" value="{{ search_query }}">
                <input type="submit" value="Search">
                <input type="hidden" name="page_size" value="{{ page_size }}">
            </form>
        </div>
    </div>

    {% if rows %}
    <div class="card" style="margin-top:10px;">
        <div style="display:flex; justify-content:space-between; flex-wrap:wrap; align-items:center;">
            <h2>Preview of Excel Data</h2>
            <a href="{{ url_for('download', search=search_query, selected_file=selected_file) }}" class="btn">Download Filtered Excel</a>
        </div>

        <form method="POST" action="{{ url_for('delete_rows') }}">
            <input type="hidden" name="selected_file" value="{{ selected_file }}">
            <div class="table-responsive">
                <table id="editableTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select_all"></th>
                            {% for col in columns %}<th>{{ col }}</th>{% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in rows %}
                        <tr>
                            <td><input type="checkbox" name="delete_checkbox" value="{{ row['_id'] }}"></td>
                            {% for col in columns %}
                            <td contenteditable="true" data-id="{{ row['_id'] }}" data-col="{{ col }}">{{ row[col] }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <button type="submit" class="btn" style="margin-top:10px; background:#ff4d4d;">Delete Selected Rows</button>
        </form>

        <div id="tableCounts" style="padding:8px; font-weight:600;">
            <span id="totalCount">Total rows: {{ total_count_all }}</span> ·
            <span id="visibleCount">Visible rows: 0</span> ·
            <span id="checkedCount">Checked: 0</span>
        </div>

        <div class="pagination">
            {% if page>1 %}
            <a href="{{ url_for('dashboard', search=search_query, page=1, page_size=page_size, selected_file=selected_file) }}">First</a>
            <a href="{{ url_for('dashboard', search=search_query, page=page-1, page_size=page_size, selected_file=selected_file) }}">Previous</a>
            {% endif %}
            {% if page<total_pages %}
            <a href="{{ url_for('dashboard', search=search_query, page=page+1, page_size=page_size, selected_file=selected_file) }}">Next</a>
            <a href="{{ url_for('dashboard', search=search_query, page=total_pages, page_size=page_size, selected_file=selected_file) }}">Last</a>
            {% endif %}
            <span style="margin-left:10px;">Page {{ page }} of {{ total_pages }}</span>
        </div>
    </div>
    {% else %}
    <div class="card" style="margin-top:20px;">
        <p>No data available. Please upload or select a file.</p>
    </div>
    {% endif %}

</div>



<script>
// Select all checkboxes
const selectAll = document.getElementById("select_all");
const checkboxes = document.querySelectorAll('input[name="delete_checkbox"]');
selectAll?.addEventListener("change", () => checkboxes.forEach(cb => cb.checked = selectAll.checked));

// Update counts
function updateCounts() {
    const visible = Array.from(document.querySelectorAll("#editableTable tbody tr")).filter(r => r.offsetParent !== null).length;
    const checked = document.querySelectorAll("#editableTable tbody input[name='delete_checkbox']:checked").length;
    document.getElementById("visibleCount").textContent = 'Visible rows: ' + visible;
    document.getElementById("checkedCount").textContent = 'Checked: ' + checked;
}
document.querySelectorAll("#editableTable tbody input[name='delete_checkbox']").forEach(cb => cb.addEventListener('change', updateCounts));
selectAll?.addEventListener('change', updateCounts);
updateCounts();

// Editable table save
function saveCell(cell) {
    const rowId = cell.dataset.id;
    const col = cell.dataset.col;
    const value = cell.innerText.trim();
    fetch("/update_cell", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({id: rowId, column: col, value: value})
    })
    .then(res => res.json())
    .then(resp => { cell.style.backgroundColor = "#d4edda"; setTimeout(()=>cell.style.backgroundColor="",1500); })
    .catch(err => { cell.style.backgroundColor = "#f8d7da"; setTimeout(()=>cell.style.backgroundColor="",2000); });
}
document.querySelectorAll("#editableTable td[contenteditable='true']").forEach(cell => {
    cell.addEventListener("blur", () => saveCell(cell));
    cell.addEventListener("keydown", e => { if(e.key==="Enter"){ e.preventDefault(); cell.blur(); }});
});
</script>

</body>
</html>
